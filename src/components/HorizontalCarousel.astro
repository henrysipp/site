---
interface Props {
  title: string;
  class?: string;
}

const { title, class: className } = Astro.props;
---

<div class:list={[className]}>
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold text-secondary">{title}</h2>
    <div class="flex gap-2">
      <button 
        class="scroll-left p-2 rounded-lg hover:bg-mist-100 dark:hover:bg-mist-800 transition-colors"
        aria-label="Scroll left"
      >
        <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button 
        class="scroll-right p-2 rounded-lg hover:bg-mist-100 dark:hover:bg-mist-800 transition-colors"
        aria-label="Scroll right"
      >
        <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
  
  <div class="relative -mx-6 md:-mx-12" data-horizontal-carousel>
    <div class="flex gap-8 overflow-x-auto px-6 md:px-12 scrollbar-hide" data-carousel-inner>
      <slot />
    </div>
  </div>
</div>

<script>
  function initCarousels() {
    const carousels = document.querySelectorAll('[data-horizontal-carousel]');
    
    carousels.forEach((carousel) => {
      if (!(carousel instanceof HTMLElement)) return;
      
      const scroller = carousel.querySelector('[data-carousel-inner]') as HTMLElement;
      if (!scroller) return;
      
      // Skip if already initialized
      if (scroller.dataset.carouselInit === 'true') return;
      scroller.dataset.carouselInit = 'true';
      
      const parent = carousel.parentElement;
      if (!parent) return;
      
      const leftBtn = parent.querySelector('.scroll-left') as HTMLButtonElement;
      const rightBtn = parent.querySelector('.scroll-right') as HTMLButtonElement;
      
      if (!leftBtn || !rightBtn) return;
      
      // Smooth scroll state
      let targetScroll = scroller.scrollLeft;
      let currentScroll = scroller.scrollLeft;
      let animating = false;
      let isHovering = false;

      scroller.addEventListener('mouseenter', () => {
        isHovering = true;
      });

      scroller.addEventListener('mouseleave', () => {
        isHovering = false;
      });

      scroller.addEventListener('wheel', (e) => {
        // Only handle actual horizontal scroll (shift+scroll or trackpad horizontal swipe)
        const hasOverflow = scroller.scrollWidth > scroller.clientWidth;
        const isHorizontalScroll = Math.abs(e.deltaX) > Math.abs(e.deltaY);
        
        if (!isHovering || !hasOverflow || !isHorizontalScroll) return;

        e.preventDefault();
        targetScroll += e.deltaX;
        targetScroll = Math.max(0, Math.min(targetScroll, scroller.scrollWidth - scroller.clientWidth));

        if (!animating) {
          animating = true;
          animate();
        }
      }, { passive: false });

      function animate() {
        currentScroll += (targetScroll - currentScroll) * 0.1;
        scroller.scrollLeft = currentScroll;

        if (Math.abs(targetScroll - currentScroll) > 0.5) {
          requestAnimationFrame(animate);
        } else {
          animating = false;
        }
      }
      
      // Button click handlers
      leftBtn.addEventListener('click', () => {
        const scrollAmount = scroller.clientWidth * 0.8;
        targetScroll = Math.max(0, targetScroll - scrollAmount);
        if (!animating) {
          animating = true;
          animate();
        }
      });
      
      rightBtn.addEventListener('click', () => {
        const scrollAmount = scroller.clientWidth * 0.8;
        targetScroll = Math.min(scroller.scrollWidth - scroller.clientWidth, targetScroll + scrollAmount);
        if (!animating) {
          animating = true;
          animate();
        }
      });
    });
  }

  // Initialize on first load
  initCarousels();

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:page-load', initCarousels);
</script>
